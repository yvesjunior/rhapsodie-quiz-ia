# ============================================
# Rhapsodie Quiz IA - Production Overrides
# ============================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# NOTE: Uses your external Nginx (kiwanoinc.ca) for SSL termination.
#       App runs on port 4040, proxied by your existing Nginx.
#       Database is NOT exposed externally (internal Docker network only).
#
# Images are pulled from Docker Hub (kiwanoinc/rhapsody-*)
# To update: docker compose -f docker-compose.yml -f docker-compose.prod.yml pull

services:
  # ============================================
  # DATABASE - Production Settings (MariaDB for lower memory usage)
  # ============================================
  rhapsody-db:
    image: mariadb:10.6
    restart: always
    # Use named volume instead of bind mount for production
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME:-elite_quiz_237}
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=100
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ============================================
  # REDIS - Production Settings
  # ============================================
  rhapsody-redis:
    restart: always
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # WEB SERVER - Production Settings
  # ============================================
  rhapsody-web:
    image: kiwanoinc/rhapsody-web:latest
    restart: always
    # Override volumes - use code from image, only mount persistent data
    volumes:
      - web_logs:/var/www/html/application/logs
      - web_cache:/var/www/html/application/cache
      - web_uploads:/var/www/html/upload
      - ./firebase-service-account.json:/var/www/credentials/firebase-service-account.json:ro
    environment:
      - CI_ENV=production
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================
  # CRON - Production Settings
  # ============================================
  rhapsody-cron:
    image: kiwanoinc/rhapsody-cron:latest
    restart: always
    # Override volumes - use code from image, only mount Firebase credentials
    volumes:
      - ./firebase-service-account.json:/var/www/credentials/firebase-service-account.json:ro
    environment:
      - CI_ENV=production
      - DAILY_CONTEST_AUTO_CREATE=true
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ============================================
  # PHPMYADMIN - Disabled in Production
  # ============================================
  rhapsody-phpmyadmin:
    profiles:
      - admin-tools  # Only enable with: --profile admin-tools

# Named volumes for persistent data
volumes:
  mysql_data:
    driver: local
  web_logs:
    driver: local
  web_cache:
    driver: local
  web_uploads:
    driver: local
